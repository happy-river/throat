{% extends "layout.html" %}
{% block title %}My messages | {{config.site.lema}}{% endblock %}

{% block navbar %}
{% endblock %}

{% block sidebar %}
{{ super() }}
{% include 'messages/sidebar.html' %}
{% endblock %}

{% block content %}
{{ super() }}
<div id="center-container">
  <div class="inbox content">
    <div class="user-activity col-12">
      <h3 style="display: inline-block;"><span class="p-icon" data-icon="mail" style="display: inline-block;"></span> {{box_name}}</h3>
      - <span class="links"><a data-bid="{{boxID}}" class="markall">Mark all as read</a></span>
      {% for message in messages %}
        <article class="pmessage post{% if not message.read %} newmsg{% endif %}">
          <div class="main">
            <p class="title">{{message.subject}}</p>
            <p class="container">{{markdown(message.content)|safe}}</p>
            <p class="author"><time-ago datetime="{{message.posted.isoformat()}}Z"></time-ago></p>
            <p class="container">
              {% if message.username %}
                <a href="{{url_for('user.view', user=message.username)}}" class="btn small">
                {% if message.sub %}
                  /u/{{message.username}} [as mod of {{message.sub}}]
		{% else %}
                  /u/{{message.username}}
		{% endif %}
		</a>
              {% elif message.sub %}
                <a href="{{url_for('sub.view_sub', sub=message.sub)}}" class="btn small">/{{config.site.sub_prefix}}/{{message.sub}}</a>
              {%else%}
                <a href="#" class="btn small">Phuks</a>
              {%endif%}
              {% if message.read %}
                <a class="read disabled">read</a>
              {% else %}
                <a class="readmsg" data-mid="{{message.mid}}">mark as read</a>
              {% endif %}
              {% if message.username or message.sub %}
              <a href="#msg-form" data-mid="{{message.mid}}" data-replyto='{{message.username}}' data-replytitle='{{message.subject}}' class="replymsg">reply</a>
              {%endif%}
              <!--<a class="btn small">forward</a>-->
              <a class="savemsg" data-mid="{{message.mid}}">save</a>
              <a class="deletemsg" data-mid="{{message.mid}}">delete</a>
              <a class="block" data-uid="{{message.sentby}}">{% if message.sentby not in func.get_ignores(current_user.uid) %}block{%else%}unblock{%endif%}</a>
            </p>
          </div>
          <div id="replyto{{message.mid}}"></div>
        </article>
      {% endfor %}
    </div>
    {% include 'messages/nav.html' %}
  </div>
</div>

<div id="msgpop" style="display:none;">
  <span class="closemsg">&times;</span>
  <div class="modal-content">
    <form data-reset="true" id="msg-form" action="{{url_for('do.create_send_reply')}}" data-redir="{{url_for('messages.inbox_sort')}}" class="pure-form pure-form-aligned ajaxform">
      {% set msgform = form.CreateUserMessageReplyForm()%}
      {{msgform.csrf_token}}
      <h3>Send reply</h3>
      <fieldset>
        <div style="display: none">
          {{msgform.reply_mid(required=True)}}
	</div>
        <div class="pure-control-group markdown-editor">
          {{msgform.content(placeholder="Styling with Markdown format is supported.", rows="10", **{'data-provide' :"markdown"})}}
        </div>
        <div class="pure-controls">
          {% if error %}
            <div class="error">{{error}}</div>
          {%endif%}
          <button type="submit" id="msg-btnsubmit" class="pure-button pure-button-primary" data-prog="Sending...">Send Message</button>
          <button type="button" data-pvid="ncme" class="pure-button btn-preview txicont" data-txid="content">Preview</button>
          <div class="cmpreview canclose" style="display:none;">
             <h4>Reply preview</h4>
             <span class="closemsg">Ã—</span>
             <div class="cpreview-content"></div>
           </div>
        </div>
      </fieldset>
    </form>
  </div>
</div>
{% endblock %}
